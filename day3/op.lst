     1                                  ; op.asm   
     2                                  ; 完整、可启动的 512 字节版本
     3                                  
     4                                  BITS 16
     5                                  ORG  0x7c00
     6                                  
     7                                  ; ---------------------------------
     8                                  ; 定义常量
     9                                  ; ---------------------------------
    10                                  CYLS EQU 10         ; 我们假设先只读 10 个柱面
    11                                  
    12                                  ; ---------------------------------
    13                                  ; FAT12 软盘头部 (BPB)
    14                                  ; ---------------------------------
    15 00000000 EB4E                        JMP entry
    16 00000002 90                          DB 0x90
    17 00000003 48454C4C4F49504C            DB "HELLOIPL" ; 厂商名 (8 字节)
    18 0000000B 0002010100                  DB 0x00, 0x02, 0x01, 0x01, 0x00
    19 00000010 02E000400BF00900            DB 0x02, 0xe0, 0x00, 0x40, 0x0b, 0xf0, 0x09, 0x00
    20 00000018 1200020000000000            DB 0x12, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00
    21 00000020 400B0000000029FF            DB 0x40, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x29, 0xff
    22 00000028 FFFFFF48454C4C4F2D-         DB 0xff, 0xff, 0xff, "HELLO-OS   " ; 卷标 (11 字节)
    22 00000031 4F53202020         
    23 00000036 4641543132202020            DB "FAT12   " ; 文件系统类型 (8 字节)
    24 0000003E 0000                        DB 0x00, 0x00
    25 00000040 <res 10h>                   RESB 16     ; 保留 16 字节
    25          ******************       warning: uninitialized space declared in .text section: zeroing [-w+zeroing]
    26                                  
    27                                  ; ---------------------------------
    28                                  ; 程序核心
    29                                  ; ---------------------------------
    30                                  entry:
    31                                      ; 初始化寄存器 (设置栈)
    32 00000050 B80000                      MOV AX, 0
    33 00000053 8ED0                        MOV SS, AX
    34 00000055 BC007C                      MOV SP, 0x7c00
    35 00000058 8ED8                        MOV DS, AX
    36                                      ; MOV ES, AX ; 后面会马上重设 ES，这句可以省略
    37                                  
    38                                  
    39                                  
    40                                  
    41                                  
    42                                  ;读磁盘
    43 0000005A B82008                      MOV AX,0x0820
    44 0000005D 8EC0                        MOV ES,AX
    45 0000005F B500                        MOV CH,0 ; 柱面0
    46 00000061 B600                        MOV DH,0 ; 磁头0
    47 00000063 B102                        MOV CL,2 ; 扇区2
    48                                  readloop:
    49 00000065 BE0000                      MOV SI,0 ; 记录失败次数的寄存器
    50                                  retry:
    51 00000068 B402                        MOV AH,0x02 ; AH=0x02 : 读入磁盘
    52 0000006A B001                        MOV AL,1 ; 1个扇区
    53 0000006C BB0000                      MOV BX,0
    54 0000006F B200                        MOV DL,0x00 ; A驱动器
    55 00000071 CD13                        INT 0x13 ; 调用磁盘BIOS
    56 00000073 7310                        JNC next ; 没出错的话跳转到fin
    57                                  
    58                                  
    59 00000075 83C601                      ADD SI,1 ; 往SI加1
    60 00000078 83FE05                      CMP SI,5 ; 比较SI与5
    61 0000007B 7334                        JAE error ; SI >= 5时，跳转到error
    62 0000007D B400                        MOV AH,0x00
    63 0000007F B200                        MOV DL,0x00 ; A驱动器
    64 00000081 CD13                        INT 0x13 ; 重置驱动器
    65 00000083 EBE3                        JMP retry
    66                                  next:
    67 00000085 8CC0                        MOV AX,ES; 把内存地址后移0x200
    68 00000087 83C020                      ADD AX,512/16
    69 0000008A 8EC0                        MOV ES,AX ; 因为没有ADD ES,0x020指令，所以这里稍微绕个弯
    70 0000008C 80C101                      ADD CL,1; 往CL里加1 
    71 0000008F 80F912                      CMP CL,18; 比较CL与18
    72 00000092 76D1                        JBE readloop ; 如果CL <= 18 跳转至readloop
    73 00000094 B101                        MOV CL,1
    74 00000096 80C601                      ADD DH,1
    75 00000099 80FE02                      CMP DH,2
    76 0000009C 72C7                        JB readloop; 如果DH < 2，则跳转到readloop(也就是失败了)
    77 0000009E B600                        MOV DH,0
    78 000000A0 80C501                      ADD CH,1
    79 000000A3 80FD0A                      CMP CH,CYLS
    80 000000A6 72BD                        JB readloop; 如果CH < CYLS，则跳转到readloop  
    81 000000A8 C706F00F0A00                MOV WORD [0x0ff0], CYLS
    82 000000AE E9(00C2)                    JMP 0xc200
    83                                  error:
    84 000000B1 EB00                        JMP fin         ; 失败了也先跳转到 fin  
    85                                  
    86                                  fin:
    87 000000B3 F4                          HLT
    88 000000B4 EBFD                        JMP fin
    89                                  
    90                                  
    91                                  ; ---------------------------------
    92                                  ; 填充 & 魔法数字 (确保 512 字节)
    93                                  ; ---------------------------------
    94 000000B6 <res 148h>                  RESB 510 - ($ - $$) 
    94          ******************       warning: uninitialized space declared in .text section: zeroing [-w+zeroing]
    95 000001FE 55AA                        DB 0x55, 0xaa
    96                                  
