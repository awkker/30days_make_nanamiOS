     1                                  ; op.asm (Day 5 - 切换到 32 位保护模式)
     2                                  ; 完整、可启动的 512 字节版本
     3                                  
     4                                  BITS 16
     5                                  ORG  0x7c00
     6                                  
     7                                  ; ---------------------------------
     8                                  ; 定义常量
     9                                  ; ---------------------------------
    10                                  CYLS EQU 10         ; 我们假设先只读 10 个柱面
    11                                  
    12                                  ; ---------------------------------
    13                                  ; FAT12 软盘头部 (BPB)
    14                                  ; ---------------------------------
    15 00000000 EB4E                        JMP entry
    16 00000002 90                          DB 0x90
    17 00000003 48454C4C4F49504C            DB "HELLOIPL" ; 厂商名 (8 字节)
    18 0000000B 0002010100                  DB 0x00, 0x02, 0x01, 0x01, 0x00
    19 00000010 02E000400BF00900            DB 0x02, 0xe0, 0x00, 0x40, 0x0b, 0xf0, 0x09, 0x00
    20 00000018 1200020000000000            DB 0x12, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00
    21 00000020 400B0000000029FF            DB 0x40, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x29, 0xff
    22 00000028 FFFFFF48454C4C4F2D-         DB 0xff, 0xff, 0xff, "HELLO-OS   " ; 卷标 (11 字节)
    22 00000031 4F53202020         
    23 00000036 4641543132202020            DB "FAT12   " ; 文件系统类型 (8 字节)
    24 0000003E 0000                        DB 0x00, 0x00
    25 00000040 <res 10h>                   RESB 16     ; 保留 16 字节
    25          ******************       warning: uninitialized space declared in .text section: zeroing [-w+zeroing]
    26                                  
    27                                  ; ---------------------------------
    28                                  ; 16 位模式程序核心
    29                                  ; ---------------------------------
    30                                  entry:
    31                                      ; 初始化寄存器 (设置栈)
    32 00000050 B80000                      MOV AX, 0
    33 00000053 8ED0                        MOV SS, AX
    34 00000055 BC007C                      MOV SP, 0x7c00
    35 00000058 8ED8                        MOV DS, AX
    36                                  
    37                                  ; ---------------------------------
    38                                  ; 读磁盘 (加载内核)
    39                                  ; ---------------------------------
    40 0000005A B82008                      MOV AX,0x0820
    41 0000005D 8EC0                        MOV ES,AX
    42 0000005F B500                        MOV CH,0 ; 柱面0
    43 00000061 B600                        MOV DH,0 ; 磁头0
    44 00000063 B102                        MOV CL,2 ; 扇区2
    45                                  readloop:
    46 00000065 BE0000                      MOV SI,0 ; 记录失败次数的寄存器
    47                                  retry:
    48 00000068 B402                        MOV AH,0x02 ; AH=0x02 : 读入磁盘
    49 0000006A B001                        MOV AL,1 ; 1个扇区
    50 0000006C BB0000                      MOV BX,0
    51 0000006F B200                        MOV DL,0x00 ; A驱动器
    52 00000071 CD13                        INT 0x13 ; 调用磁盘BIOS
    53 00000073 7312                        JNC next
    54 00000075 83C601                      ADD SI,1
    55 00000078 83FE05                      CMP SI,5
    56 0000007B 7308                        JAE error
    57 0000007D B400                        MOV AH,0x00
    58 0000007F B200                        MOV DL,0x00
    59 00000081 CD13                        INT 0x13
    60 00000083 EBE3                        JMP retry
    61                                  error:
    62 00000085 EB60                        JMP fin  
    63                                  
    64                                  next:
    65 00000087 8CC0                        MOV AX,ES
    66 00000089 83C020                      ADD AX, 512/16
    67 0000008C 8EC0                        MOV ES,AX
    68 0000008E 80C101                      ADD CL,1
    69 00000091 80F912                      CMP CL,18
    70 00000094 76CF                        JBE readloop
    71 00000096 B101                        MOV CL,1
    72 00000098 80C601                      ADD DH,1
    73 0000009B 80FE02                      CMP DH,2
    74 0000009E 72C5                        JB readloop
    75 000000A0 B600                        MOV DH,0
    76 000000A2 80C501                      ADD CH,1
    77 000000A5 80FD0A                      CMP CH,CYLS
    78 000000A8 72BB                        JB readloop
    79                                  
    80                                  ; ---------------------------------
    81                                  ; ★★★ 切换到 32 位保护模式 ★★★
    82                                  ; ---------------------------------
    83                                  
    84                                      ; 1. 写入 CYLS 信息
    85 000000AA C706F00F0A00                MOV WORD [0x0ff0], CYLS
    86                                  
    87                                      ; 2. 键盘控制器：打开 A20 Gate
    88                                      ;    (允许 CPU 访问 1MB 以上内存)
    89                                  wait_KBC_sendready:
    90 000000B0 E464                        IN  AL, 0x64
    91 000000B2 2402                        AND AL, 0x02
    92 000000B4 75FA                        JNE wait_KBC_sendready
    93 000000B6 B0D1                        MOV AL, 0xd1
    94 000000B8 E664                        OUT 0x64, AL
    95                                  wait_KBC_sendready_2:
    96 000000BA E464                        IN  AL, 0x64
    97 000000BC 2402                        AND AL, 0x02
    98 000000BE 75FA                        JNE wait_KBC_sendready_2
    99 000000C0 B0DF                        MOV AL, 0xdf  ; 0xdf = 开启 A20
   100 000000C2 E660                        OUT 0x60, AL
   101                                  wait_KBC_sendready_3:
   102 000000C4 E464                        IN  AL, 0x64
   103 000000C6 2402                        AND AL, 0x02
   104 000000C8 75FA                        JNE wait_KBC_sendready_3
   105                                  
   106                                      ; 3. 加载 GDT (全局描述符表)
   107                                      ;    GDT 告诉 CPU 32位模式下的内存布局
   108 000000CA 0F0116[0201]                LGDT [GDTR0]
   109                                  
   110                                      ; 4. 拨动开关！设置 CR0 寄存器的 PE 位
   111                                      ;    PE=1 (Protection Enable)
   112 000000CF 0F20C0                      MOV EAX, CR0
   113 000000D2 6625FFFFFF7F                AND EAX, 0x7fffffff ; (书中不用)
   114 000000D8 6683C801                    OR  EAX, 0x00000001
   115 000000DC 0F22C0                      MOV CR0, EAX
   116                                  
   117                                      ; 5. ★★★ 真正切换！ ★★★
   118                                      ;    一个 JMP 指令清空 CPU 缓存，
   119                                      ;    并设置 CS 寄存器为 0x0008 (32位代码段)
   120 000000DF 66EA[08010000]0800          JMP DWORD 8:prot_mode_start ; 8 = 0x0008
   121                                  
   122                                  fin:
   123 000000E7 F4                          HLT
   124 000000E8 EBFD                        JMP fin
   125                                  
   126                                  ; ---------------------------------
   127                                  ; GDT (全局描述符表)
   128                                  ; ---------------------------------
   129                                  GDT0:
   130                                      ; 空描述符 (必须有)
   131 000000EA ????????????????            RESB 8
   131          ******************       warning: uninitialized space declared in .text section: zeroing [-w+zeroing]
   132                                      ; 代码段描述符 (4GB)
   133 000000F2 FFFF                        DW 0xffff   ; 段界限 (low)
   134 000000F4 0000                        DW 0x0000   ; 段基址 (low)
   135 000000F6 00                          DB 0x00     ; 段基址 (mid)
   136 000000F7 9A                          DB 0x9a     ; 属性 (P=1, DPL=00, S=1, TYPE=1010 -> 可执行/可读)
   137 000000F8 CF                          DB 0xcf     ; 属性+界限 (G=1, D=1, L=0, AVL=0, Limit=1111)
   138 000000F9 00                          DB 0x00     ; 段基址 (high)
   139                                      ; 数据段描述符 (4GB)
   140 000000FA FFFF                        DW 0xffff
   141 000000FC 0000                        DW 0x0000
   142 000000FE 00                          DB 0x00
   143 000000FF 92                          DB 0x92     ; 属性 (P=1, DPL=00, S=1, TYPE=0010 -> 可读/可写)
   144 00000100 CF                          DB 0xcf
   145 00000101 00                          DB 0x00
   146                                  
   147                                  GDTR0:
   148 00000102 1700                        DW 8*3 - 1  ; GDT 界限 (23)
   149 00000104 [EA000000]                  DD GDT0     ; GDT 起始地址
   150                                  
   151                                  ; ---------------------------------
   152                                  ; 32 位模式代码 BITS 32
   153                                  ; ---------------------------------
   154                                  BITS 32
   155                                  prot_mode_start:
   156                                      ; 设置 32 位数据段寄存器
   157 00000108 66B81000                    MOV AX, 0x0010  ; 0x0010 是数据段 (GDT 的第 2 项)
   158 0000010C 8ED8                        MOV DS, AX
   159 0000010E 8EC0                        MOV ES, AX
   160 00000110 8EE0                        MOV FS, AX
   161 00000112 8EE8                        MOV GS, AX
   162 00000114 8ED0                        MOV SS, AX
   163                                      
   164 00000116 BC00FC0900                  MOV ESP, 0x9fc00 
   165                                      
   166                                      ; 跳转到 C 语言内核！
   167 0000011B E9(00C20000)                JMP 0xc200
   168                                  
   169                                  ; ---------------------------------
   170                                  ; 填充 & 魔法数字 (确保 512 字节)
   171                                  ; ---------------------------------
   172                                  BITS 16
   173 00000120 <res DEh>                   RESB 510 - ($ - $$) 
   173          ******************       warning: uninitialized space declared in .text section: zeroing [-w+zeroing]
   174 000001FE 55AA                        DB 0x55, 0xaa
   175                                  
