     1                                  ; naskfunc.nas - 现代化的 NASM 语法
     2                                  ; TAB=4
     3                                  ; 提供操作系统开发所需的底层汇编函数
     4                                  
     5                                  ; ---------------------------------
     6                                  ; 说明：
     7                                  ; - 使用标准 NASM 语法，不使用旧的 NASK 专有指令
     8                                  ; - 所有函数使用 cdecl 调用约定（参数从右到左压栈，调用者清理栈）
     9                                  ; ---------------------------------
    10                                  
    11                                  BITS 32         ; 32 位保护模式代码
    12                                  SECTION .text   ; 代码段
    13                                  
    14                                  ; ---------------------------------
    15                                  ; 声明全局符号（导出给 C 语言使用）
    16                                  ; ---------------------------------
    17                                  GLOBAL  io_hlt, io_cli, io_sti, io_stihlt
    18                                  GLOBAL  io_in8, io_in16, io_in32
    19                                  GLOBAL  io_out8, io_out16, io_out32
    20                                  GLOBAL  io_load_eflags, io_store_eflags
    21                                  GLOBAL  load_gdtr, load_idtr
    22                                  GLOBAL  write_mem8
    23                                  GLOBAL  asm_inthandler21, asm_inthandler2c
    24                                  
    25                                  ; ---------------------------------
    26                                  ; 声明外部符号（从 C 语言导入）
    27                                  ; ---------------------------------
    28                                  EXTERN  inthandler21, inthandler2c
    29                                  
    30                                  ; =================================
    31                                  ; CPU 控制指令
    32                                  ; =================================
    33                                  
    34                                  io_hlt:         ; void io_hlt(void);
    35 00000000 F4                          HLT         ; 暂停 CPU，等待下一次中断
    36 00000001 C3                          RET
    37                                  
    38                                  io_cli:         ; void io_cli(void);
    39 00000002 FA                          CLI         ; 禁用中断（Clear Interrupt Flag）
    40 00000003 C3                          RET
    41                                  
    42                                  io_sti:         ; void io_sti(void);
    43 00000004 FB                          STI         ; 启用中断（Set Interrupt Flag）
    44 00000005 C3                          RET
    45                                  
    46                                  io_stihlt:      ; void io_stihlt(void);
    47 00000006 FB                          STI         ; 开中断
    48 00000007 F4                          HLT         ; 暂停（等待中断唤醒）
    49 00000008 C3                          RET
    50                                  
    51                                  ; =================================
    52                                  ; 端口输入指令（从设备读取数据）
    53                                  ; =================================
    54                                  
    55                                  io_in8:         ; int io_in8(int port);
    56 00000009 8B542404                    MOV     EDX, [ESP+4]    ; EDX = port
    57 0000000D B800000000                  MOV     EAX, 0          ; 清空 EAX
    58 00000012 EC                          IN      AL, DX          ; 从端口读取 8 位数据到 AL
    59 00000013 C3                          RET
    60                                  
    61                                  io_in16:        ; int io_in16(int port);
    62 00000014 8B542404                    MOV     EDX, [ESP+4]    ; EDX = port
    63 00000018 B800000000                  MOV     EAX, 0          ; 清空 EAX
    64 0000001D 66ED                        IN      AX, DX          ; 从端口读取 16 位数据到 AX
    65 0000001F C3                          RET
    66                                  
    67                                  io_in32:        ; int io_in32(int port);
    68 00000020 8B542404                    MOV     EDX, [ESP+4]    ; EDX = port
    69 00000024 ED                          IN      EAX, DX         ; 从端口读取 32 位数据到 EAX
    70 00000025 C3                          RET
    71                                  
    72                                  ; =================================
    73                                  ; 端口输出指令（向设备写入数据）
    74                                  ; =================================
    75                                  
    76                                  io_out8:        ; void io_out8(int port, int data);
    77 00000026 8B542404                    MOV     EDX, [ESP+4]    ; EDX = port
    78 0000002A 8A442408                    MOV     AL, [ESP+8]     ; AL = data (低 8 位)
    79 0000002E EE                          OUT     DX, AL          ; 向端口输出 8 位数据
    80 0000002F C3                          RET
    81                                  
    82                                  io_out16:       ; void io_out16(int port, int data);
    83 00000030 8B542404                    MOV     EDX, [ESP+4]    ; EDX = port
    84 00000034 8B442408                    MOV     EAX, [ESP+8]    ; EAX = data
    85 00000038 66EF                        OUT     DX, AX          ; 向端口输出 16 位数据
    86 0000003A C3                          RET
    87                                  
    88                                  io_out32:       ; void io_out32(int port, int data);
    89 0000003B 8B542404                    MOV     EDX, [ESP+4]    ; EDX = port
    90 0000003F 8B442408                    MOV     EAX, [ESP+8]    ; EAX = data
    91 00000043 EF                          OUT     DX, EAX         ; 向端口输出 32 位数据
    92 00000044 C3                          RET
    93                                  
    94                                  ; =================================
    95                                  ; EFLAGS 寄存器操作
    96                                  ; =================================
    97                                  
    98                                  io_load_eflags:     ; int io_load_eflags(void);
    99 00000045 9C                          PUSHFD              ; 将 EFLAGS 压栈（PUSH EFLAGS Doubleword）
   100 00000046 58                          POP     EAX         ; 弹出到 EAX 返回
   101 00000047 C3                          RET
   102                                  
   103                                  io_store_eflags:    ; void io_store_eflags(int eflags);
   104 00000048 8B442404                    MOV     EAX, [ESP+4]    ; EAX = eflags
   105 0000004C 50                          PUSH    EAX             ; 压栈
   106 0000004D 9D                          POPFD                   ; 从栈恢复到 EFLAGS（POP to EFLAGS Doubleword）
   107 0000004E C3                          RET
   108                                  
   109                                  ; =================================
   110                                  ; 内存操作辅助函数
   111                                  ; =================================
   112                                  
   113                                  write_mem8:     ; void write_mem8(int addr, int data);
   114 0000004F 8B4C2404                    MOV     ECX, [ESP+4]    ; ECX = addr
   115 00000053 8A442408                    MOV     AL, [ESP+8]     ; AL = data (低 8 位)
   116 00000057 8801                        MOV     [ECX], AL       ; 写入内存 [addr] = data
   117 00000059 C3                          RET
   118                                  
   119                                  ; =================================
   120                                  ; GDT/IDT 寄存器加载
   121                                  ; =================================
   122                                  
   123                                  load_gdtr:      ; void load_gdtr(int limit, int addr);
   124 0000005A 668B442404                  MOV     AX, [ESP+4]     ; limit
   125 0000005F 6689442406                  MOV     [ESP+6], AX
   126 00000064 0F01542406                  LGDT    [ESP+6]         ; 加载 GDTR
   127 00000069 C3                          RET
   128                                  
   129                                  load_idtr:      ; void load_idtr(int limit, int addr);
   130 0000006A 668B442404                  MOV     AX, [ESP+4]     ; limit
   131 0000006F 6689442406                  MOV     [ESP+6], AX
   132 00000074 0F015C2406                  LIDT    [ESP+6]         ; 加载 IDTR
   133 00000079 C3                          RET
   134                                  
   135                                  ; =================================
   136                                  ; 中断处理程序包装
   137                                  ; =================================
   138                                  
   139                                  asm_inthandler21:   ; void asm_inthandler21(void);
   140 0000007A 06                          PUSH    ES
   141 0000007B 1E                          PUSH    DS
   142 0000007C 60                          PUSHAD
   143 0000007D 89E0                        MOV     EAX, ESP
   144 0000007F 50                          PUSH    EAX
   145 00000080 668CD0                      MOV     AX, SS
   146 00000083 8ED8                        MOV     DS, AX
   147 00000085 8EC0                        MOV     ES, AX
   148 00000087 E8(00000000)                CALL    inthandler21
   149 0000008C 58                          POP     EAX
   150 0000008D 61                          POPAD
   151 0000008E 1F                          POP     DS
   152 0000008F 07                          POP     ES
   153 00000090 CF                          IRETD
   154                                  
   155                                  asm_inthandler2c:   ; void asm_inthandler2c(void);
   156 00000091 06                          PUSH    ES
   157 00000092 1E                          PUSH    DS
   158 00000093 60                          PUSHAD
   159 00000094 89E0                        MOV     EAX, ESP
   160 00000096 50                          PUSH    EAX
   161 00000097 668CD0                      MOV     AX, SS
   162 0000009A 8ED8                        MOV     DS, AX
   163 0000009C 8EC0                        MOV     ES, AX
   164 0000009E E8(00000000)                CALL    inthandler2c
   165 000000A3 58                          POP     EAX
   166 000000A4 61                          POPAD
   167 000000A5 1F                          POP     DS
   168 000000A6 07                          POP     ES
   169 000000A7 CF                          IRETD
